const fs = require('fs');
const path = require('path');

// Configuration paths
const API_ROOT = path.resolve(__dirname, '..');
const CONTRACTS_ROOT = path.resolve(API_ROOT, '../../packages/contracts');
const GENERATED_DIR = path.join(API_ROOT, 'prisma-type-generated');
const TARGET_DIR = path.join(CONTRACTS_ROOT, 'src', 'prisma-type-generated');

// Ensure directory exists
function ensureDir(dir) {
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
  }
}

// Generate index.ts file
function generateIndexTs() {
  const indexContent = `export const __prisma_types_marker = true;
export * from './prisma/models';
export * from './prisma/commonInputTypes';
export * from './prisma/enums';

export * from './zod/index';

`;
  
  const indexPath = path.join(GENERATED_DIR, 'index.ts');
  fs.writeFileSync(indexPath, indexContent);
  console.log('‚úÖ Generated index.ts');
}

// Generate _prisma-zod-input.ts file
function generatePrismaZodInputTs() {
  const zodInputContent = `/*
  This is a hack file for zod-prisma-types because it doesn't support the prisma new generator 
  and requires a Prisma client output path for some type references. can be moved after the new generator is supported.
*/ 
export namespace Prisma {
    export type JsonValue = string | number | boolean | null | JsonValue[] | { [key: string]: JsonValue | undefined };
    export type InputJsonValue = string | number | boolean | { toJSON(): any } | InputJsonValue[] | { [key: string]: InputJsonValue | null } | null;
  
    export class DbNull {
      private DbNull!: never;
    }
  
    export class JsonNull {
      private JsonNull!: never;
    }
  
    export class AnyNull {
      private AnyNull!: never;
    }
  
  
    export namespace NullTypes {
      export type DbNull = Prisma.DbNull;
      export type JsonNull = Prisma.JsonNull;
      export type AnyNull = Prisma.AnyNull;
    }
}
`;
  
  const zodInputPath = path.join(GENERATED_DIR, 'zod', '_prisma-zod-input.ts');
  ensureDir(path.dirname(zodInputPath));
  fs.writeFileSync(zodInputPath, zodInputContent);
  console.log('‚úÖ Generated _prisma-zod-input.ts');
}

// Generate README.md file
function generateReadme() {
  const readmeContent = `# Prisma Type Generated

‚ö†Ô∏è **WARNING: DO NOT MODIFY ANY CONTENT IN THIS FOLDER**

This folder contains auto-generated Prisma types and Zod schemas. All files in this directory are automatically generated by the \`generate-prisma-types.js\` script and will be overwritten on the next generation.

## What's in this folder:

- \`prisma/\` - Generated Prisma type definitions (models, enums, etc.)
- \`zod/\` - Generated Zod validation schemas

## How to regenerate:

Run the following command from the apps/api directory:
\`\`\`bash
npm run prisma:generate
\`\`\`

This will:
1. Generate Prisma client types
2. Generate Zod schemas
3. Create the necessary TypeScript files
4. Move everything to this location

## Important Notes:

- **Never edit files in this folder manually** - your changes will be lost
- If you need to modify types, update the Prisma schema (\`schema.prisma\`) instead
- If you need to customize Zod schemas, modify the Zod generator configuration
- This folder is automatically cleaned and regenerated on each build
`;
  
  const readmePath = path.join(GENERATED_DIR, 'README.md');
  fs.writeFileSync(readmePath, readmeContent);
  console.log('‚úÖ Generated README.md');
}

// Move to target directory
function moveToContracts() {
  // Ensure target directory exists
  ensureDir(path.dirname(TARGET_DIR));
  
  // If target directory already exists, delete it first
  if (fs.existsSync(TARGET_DIR)) {
    fs.rmSync(TARGET_DIR, { recursive: true, force: true });
  }
  
  // Move the folder
  fs.renameSync(GENERATED_DIR, TARGET_DIR);
  console.log(`‚úÖ Moved to ${TARGET_DIR}`);
}

// Main function
function main() {
  console.log('üöÄ Starting Prisma type generation...');
  
  try {
    // Ensure generated directory exists
    ensureDir(GENERATED_DIR);
    
    // Generate custom files
    generateIndexTs();
    generatePrismaZodInputTs();
    generateReadme();
    
    // Move to contracts package
    moveToContracts();
    
    console.log('üéâ Prisma type generation completed successfully!');
  } catch (error) {
    console.error('‚ùå Error during generation:', error);
    process.exit(1);
  }
}

// Run script
if (require.main === module) {
  main();
}

module.exports = { main };
