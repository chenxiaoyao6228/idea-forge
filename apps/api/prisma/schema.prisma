datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// old prisma-client generator for runtime, used in the backend
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

generator clientType {
  provider      = "prisma-client"
  output        = "../prisma-type-generated/prisma"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

generator zod {
  provider                         = "zod-prisma-types"
  prismaClientPath                 = "./_prisma-zod-input"
  output                           = "../prisma-type-generated/zod"
  createModelTypes                 = true // default is true
  writeBarrelFiles                 = true // default is true
  useDefaultValidators             = true // default is true
  coerceDate                       = true // default is true
  createInputTypes                 = false // default is true
  useMultipleFiles                 = false // default is false
  createOutputTypes                = false // default is true
  addInputTypeValidation           = false // default is true
  addInputTypeSchemas              = false // default is true
  addIncludeType                   = false // default is true
  addSelectType                    = false // default is true
  validateWhereUniqueInput         = false // default is false
  createOptionalDefaultValuesTypes = false // default is false
  createRelationValuesTypes        = false // default is false
  createPartialTypes               = false // default is false
  writeNullishInModelTypes         = false // default is false
}

model DocumentPermission {
  id                  String                    @id @default(cuid())
  userId              String?
  guestCollaboratorId String?
  docId               String
  doc                 Doc                       @relation(fields: [docId], references: [id], onDelete: Cascade)
  permission          PermissionLevel
  inheritedFromId     String? // for inheritance
  inheritedFromType   PermissionInheritanceType
  priority            Int
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  createdById         String

  inheritedFrom DocumentPermission?  @relation("DocumentPermissionInheritance", fields: [inheritedFromId], references: [id])
  children      DocumentPermission[] @relation("DocumentPermissionInheritance")

  user              User?              @relation("UserDocumentPermissions", fields: [userId], references: [id])
  guestCollaborator GuestCollaborator? @relation(fields: [guestCollaboratorId], references: [id])
  createdBy         User               @relation("CreatedDocumentPermissions", fields: [createdById], references: [id])

  @@unique([userId, docId, inheritedFromType])
  @@unique([guestCollaboratorId, docId, inheritedFromType])
  @@index([userId, docId])
  @@index([guestCollaboratorId, docId])
  @@index([docId])
  @@index([priority])
}

enum PermissionInheritanceType {
  DIRECT // directly assigned permission (priority: 1)    
  GROUP // group permission (priority: 2)      
  SUBSPACE_ADMIN // subspace admin (priority: 3)    
  SUBSPACE_MEMBER // subspace member (priority: 4)    
  WORKSPACE_ADMIN // workspace admin (priority: 5)    
  WORKSPACE_MEMBER // workspace member (priority: 6)    
  GUEST // guest permission (priority: 7)  
}

enum PermissionLevel {
  NONE
  READ
  COMMENT
  EDIT
  MANAGE
}

model User {
  id          String  @id @default(uuid())
  email       String  @unique
  displayName String? // Display name (used as primary identifier)
  imageUrl    String? // Profile image URL

  // Account status
  emailVerified DateTime? // Email verification timestamp
  status        UserStatus @default(PENDING) // Account status

  // Timestamps
  createdAt DateTime @default(now()) @db.Timestamp() // Account creation time
  updatedAt DateTime @updatedAt // Last update time

  // Security
  hashedRefreshToken String? // Refresh token for authentication
  password           Password? // Hashed password
  connections        Connection[] // OAuth connections

  // Current workspace context
  currentWorkspaceId String? // Currently active workspace ID
  currentWorkspace   Workspace? @relation("UserCurrentWorkspace", fields: [currentWorkspaceId], references: [id])

  // Document relationships
  authoredDocs     Doc[]      @relation("DocAuthor") // Documents created by user
  createdDocs      Doc[]      @relation("DocCreator") // Documents created by user
  lastModifiedDocs Doc[]      @relation("DocLastModifier") // Documents last modified by user
  sharedDocs       DocShare[] @relation("SharedToUser") // Documents shared with user
  docShare         DocShare[] // Documents shared by user

  // Version history
  docRevisions DocRevision[] // Document revision history

  // File storage
  file         File[] // Files uploaded by user
  aiTokenUsage AITokenUsage? // AI token usage tracking

  // Activity logs
  userLoginHistory UserLoginHistory[] // User login history records

  // Workspace memberships
  workspaceMembers WorkspaceMember[] // Workspace memberships
  subspaceMembers  SubspaceMember[] // Subspace memberships

  // Group memberships
  memberGroups MemberGroupUser[] // Group memberships

  // Guest invitations
  guestInvitations GuestCollaborator[] @relation("InvitedBy") // Guest invitations sent

  // Guest access (user as guest in other workspaces)
  // guestCollaborations GuestCollaborator[] // Workspaces where this user is a guest

  // Public workspace invitations generated by user
  createdPublicInvites WorkspacePublicInvite[] @relation("WorkspacePublicInviteCreatedBy")

  // Document permissions
  documentPermissions        DocumentPermission[] @relation("UserDocumentPermissions")
  createdDocumentPermissions DocumentPermission[] @relation("CreatedDocumentPermissions")

  // Star relationships
  stars Star[] // User's starred items
}

enum UserStatus {
  PENDING // Registration pending verification (email/phone not verified)
  ACTIVE // Normal active status
  SUSPENDED // Temporarily suspended (violation of rules, etc.)
  REVOKED // Permanently banned (serious violation)
  ARCHIVED // Account archived (long-term inactive)
}

model Workspace {
  id          String        @id @default(cuid())
  name        String
  description String?
  avatar      String?
  type        WorkspaceType @default(TEAM)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  memberSubspaceCreate Boolean @default(false)
  settings             Json?

  // relations
  subspaces    Subspace[]
  members      WorkspaceMember[]
  guests       GuestCollaborator[]
  memberGroups MemberGroup[]
  docs         Doc[]
  publicInvite WorkspacePublicInvite?

  // Current workspace users
  currentUsers User[] @relation("UserCurrentWorkspace")
}

model WorkspacePublicInvite {
  id          String    @id @default(cuid())
  token       String    @unique
  workspaceId String    @unique
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdById String
  createdBy   User      @relation("WorkspacePublicInviteCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime  @default(now())
  expiresAt   DateTime
  revokedAt   DateTime?
}

enum DocVisibility {
  PUBLIC // visible to everyone, (eg: product user guide, etc.)
  SHARED // visible to specific members, need further permission control check
  PRIVATE // visible to author
  WORKSPACE // visible to workspace, need further permission control check
}

model Doc {
  id            String  @id @default(cuid())
  type          DocType @default(NOTE)
  title         String
  content       String  @default("{}") // doc json snapshot
  contentBinary Bytes? // yjs collaborative document

  // state mark
  archivedAt  DateTime?
  publishedAt DateTime?
  deletedAt   DateTime?

  // position
  parentId String?

  // timestamps
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  // appearance
  icon         String?
  coverImage   CoverImage?
  coverImageId String?

  // visibility
  visibility DocVisibility @default(WORKSPACE)

  // relations
  author   User   @relation("DocAuthor", fields: [authorId], references: [id])
  authorId String

  createdBy   User   @relation("DocCreator", fields: [createdById], references: [id])
  createdById String

  lastModifiedBy   User   @relation("DocLastModifier", fields: [lastModifiedById], references: [id])
  lastModifiedById String

  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId String

  subspace   Subspace? @relation(fields: [subspaceId], references: [id])
  subspaceId String?

  parent   Doc?  @relation("DocToDoc", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children Doc[] @relation("DocToDoc")

  // sharing and permissions
  docShare    DocShare[]
  permissions DocumentPermission[]

  // Subspace permission overrides (null means inherit from subspace)
  subspaceAdminPermission     PermissionLevel?
  subspaceMemberPermission    PermissionLevel?
  nonSubspaceMemberPermission PermissionLevel?

  // publicShare        PublicShare?

  // versions
  revisions DocRevision[]

  // star relationships
  stars Star[] // Stars for this document

  // Indexes for performance
  @@index([parentId])
  @@index([workspaceId])
  @@index([subspaceId])
}

model WorkspaceMember {
  id        String        @id @default(cuid())
  role      WorkspaceRole @default(MEMBER)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  preferences Json? // User preferences
  index       String? // Fractional index for ordering

  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId String
  user        User      @relation(fields: [userId], references: [id])
  userId      String

  @@unique([workspaceId, userId])
  @@index([userId, index])
}

model Subspace {
  id          String       @id @default(cuid())
  name        String
  description String?
  avatar      String?
  type        SubspaceType @default(PUBLIC)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  archivedAt  DateTime?

  // Security settings
  allowExport        Boolean @default(true)
  allowMemberInvites Boolean @default(true)
  allowTopLevelEdit  Boolean @default(true)

  // Permission management
  memberInvitePermission String @default("ALL_MEMBERS") // ALL_MEMBERS, ADMINS_ONLY
  topLevelEditPermission String @default("ADMINS_ONLY") // ALL_MEMBERS, ADMINS_ONLY

  // Role-based permission settings
  subspaceAdminPermission     PermissionLevel @default(MANAGE)
  subspaceMemberPermission    PermissionLevel @default(MANAGE)
  nonSubspaceMemberPermission PermissionLevel @default(COMMENT)

  settings Json?

  navigationTree Json?
  index          String?

  // relations
  workspace   Workspace        @relation(fields: [workspaceId], references: [id])
  workspaceId String
  docs        Doc[]
  members     SubspaceMember[]
}

model SubspaceMember {
  id        String       @id @default(cuid())
  role      SubspaceRole @default(MEMBER)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @default(now())

  subspace   Subspace @relation(fields: [subspaceId], references: [id])
  subspaceId String

  user   User   @relation(fields: [userId], references: [id])
  userId String

  @@unique([subspaceId, userId])
}

enum SubspaceType {
  WORKSPACE_WIDE //  All workspace members are automatically members of this space (cannot leave). 
  PUBLIC // Any workspace member can join and leave freely. 
  INVITE_ONLY // Visible to all members but requires invitation to join.
  PRIVATE //  Only visible to invited members, completely hidden from others.
  PERSONAL // Only visible to the creator, completely hidden from others.
}

// Group of users in workspace
model MemberGroup {
  id          String    @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  validUntil  DateTime?

  workspace   Workspace         @relation(fields: [workspaceId], references: [id])
  workspaceId String
  members     MemberGroupUser[]
}

model MemberGroupUser {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  group   MemberGroup @relation(fields: [groupId], references: [id])
  groupId String
  user    User        @relation(fields: [userId], references: [id])
  userId  String

  @@unique([groupId, userId])
}

// User belongs to other workspace, but come to current workspace as a guest
// can be upgraded to workspace member
model GuestCollaborator {
  id        String      @id @default(cuid())
  email     String
  name      String?
  status    GuestStatus @default(PENDING)
  expireAt  DateTime
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // Link to user account (null until they create account)
  // user   User?   @relation(fields: [userId], references: [id])
  // userId String?

  invitedBy           User                 @relation("InvitedBy", fields: [invitedById], references: [id])
  invitedById         String
  workspace           Workspace            @relation(fields: [workspaceId], references: [id])
  workspaceId         String
  documentPermissions DocumentPermission[]
  // @@unique([userId, workspaceId]) // Prevent duplicate guest records for same user

  @@unique([email, workspaceId])
}

enum GuestStatus {
  PENDING
  ACTIVE
  EXPIRED
  REVOKED
}

model DocShare {
  id       String @id @default(cuid())
  doc      Doc    @relation(fields: [docId], references: [id], onDelete: Cascade)
  docId    String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId String
  sharedTo User   @relation("SharedToUser", fields: [userId], references: [id], onDelete: Cascade)
  userId   String

  permission PermissionLevel @default(READ)

  // Key field: Support folder tree sharing
  includeChildDocuments Boolean @default(false) // Whether to include child documents

  // Share status control  
  published Boolean   @default(false) // Whether publicly published
  revokedAt DateTime? // Revocation time

  // Access control  
  expiresAt DateTime? // Expiration time
  urlId     String? // Custom URL identifier

  // Statistics  
  viewCount      Int       @default(0) // Number of views
  lastAccessedAt DateTime? // Last access time

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([docId, userId])
  @@index([userId, createdAt])
  @@index([docId, includeChildDocuments])
}

model Password {
  hash String

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId String @unique
}

model Connection {
  id           String @id @default(cuid())
  providerName String // Provider name: github, google etc.
  providerId   String // Provider's user ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@unique([providerName, providerId])
}

model CoverImage {
  id       String  @id @default(cuid())
  url      String
  scrollY  Float
  doc      Doc     @relation(fields: [docId], references: [id])
  docId    String  @unique
  isPreset Boolean @default(false)
}

model DocRevision {
  id            String   @id @default(cuid())
  title         String
  content       String
  contentBinary Bytes?
  createdAt     DateTime @default(now())

  doc      Doc    @relation(fields: [docId], references: [id], onDelete: Cascade)
  docId    String
  author   User   @relation(fields: [authorId], references: [id])
  authorId String

  @@index([docId, createdAt])
}

model File {
  id          String   @id @default(cuid())
  key         String   @unique
  url         String   @default("")
  status      String   @default("pending") // pending/active/deleted
  size        Int      @default(0)
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  contentType String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AITokenUsage {
  id            String   @id @default(cuid())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String   @unique
  tokensUsed    Int      @default(0)
  lastResetDate DateTime @default(now())
  monthlyLimit  Int      @default(10000)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, lastResetDate])
}

model UserLoginHistory {
  id        String   @id @default(cuid())
  userId    String
  ip        String?
  location  String?
  loginTime DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Star {
  id        String   @id @default(cuid())
  index     String?  @db.VarChar(256) // For sorting
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations 
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  doc    Doc    @relation(fields: [docId], references: [id], onDelete: Cascade)
  docId  String

  // Ensure each user can only star a document once
  @@unique([userId, docId])
}

enum WorkspaceRole {
  OWNER // Can delete the workspace/transfer ownership/has all ADMIN permissions
  ADMIN // Can manage workspace settings, add/remove members, add/remove member groups, manage all documents in the workspace, etc
  MEMBER // Can create documents/ join subspaces/ create member groups(if allowed in workspace settings) / Cannot see private content unless explicitly shared
}

enum SubspaceRole {
  ADMIN // Can manage subspace settings, add/remove members, manage  all documents in the subspace, etc
  MEMBER
}

enum DocType {
  NOTE
  WHITEBOARD
  MIND
}

enum WorkspaceType {
  PERSONAL
  TEAM
}
