generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

generator zod {
  provider                         = "zod-prisma-types"
  output                           = "../../contracts/src/schema"
  useMultipleFiles                 = true // default is false
  writeBarrelFiles                 = true // default is true
  createInputTypes                 = false // default is true
  createModelTypes                 = true // default is true
  addInputTypeValidation           = false // default is true
  addIncludeType                   = false // default is true
  addSelectType                    = false // default is true
  validateWhereUniqueInput         = false // default is false
  createOptionalDefaultValuesTypes = true // default is false
  createRelationValuesTypes        = false // default is false
  createPartialTypes               = false // default is false
  useDefaultValidators             = true // default is true
  coerceDate                       = true // default is true
  writeNullishInModelTypes         = false // default is false
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          Int     @id @default(autoincrement())
  email       String  @unique
  displayName String? // Display name (used as primary identifier)
  imageUrl    String? // Profile image URL

  // Account status
  emailVerified DateTime? // Email verification timestamp
  status        UserStatus @default(PENDING) // Account status

  // Timestamps
  createdAt DateTime @default(now()) @db.Timestamp() // Account creation time
  updatedAt DateTime @updatedAt // Last update time

  // Security
  hashedRefreshToken String? // Refresh token for authentication
  password           Password? // Hashed password
  connections        Connection[] // OAuth connections

  // Document relationships
  authoredDocs     Doc[]      @relation("DocAuthor") // Documents created by user
  createdDocs      Doc[]      @relation("DocCreator") // Documents created by user
  lastModifiedDocs Doc[]      @relation("DocLastModifier") // Documents last modified by user
  sharedDocs       DocShare[] @relation("SharedToUser") // Documents shared with user
  docShare         DocShare[] // Documents shared by user

  // Public sharing
  createdPublicShares PublicShare[] // Public shares created by user

  // Version history
  docRevisions DocRevision[] // Document revision history

  // File storage
  file         File[] // Files uploaded by user
  aiTokenUsage AITokenUsage? // AI token usage tracking

  // Activity logs
  userLoginHistory UserLoginHistory[] // User login history records

  // Workspace memberships
  workspaceMembers WorkspaceMember[] // Workspace memberships
  subspaceMembers  SubspaceMember[] // Subspace memberships

  // Group memberships
  memberGroups MemberGroupUser[] // Group memberships

  // Guest invitations
  guestInvitations         GuestCollaborator[]        @relation("InvitedBy") // Guest invitations sent
  SubspaceMemberPermission SubspaceMemberPermission[]

  // Star relationships
  stars                   Star[] // User's starred items
  docGroupPermissions     DocGroupPermission[] @relation("UserGroupPermissions")
  docUserPermissions      DocUserPermission[]  @relation("UserDocPermissions")
  createdGroupPermissions DocGroupPermission[] @relation("CreatedGroupPermissions")
  createdUserPermissions  DocUserPermission[]  @relation("CreatedUserPermissions")
}

enum UserStatus {
  PENDING // Registration pending verification (email/phone not verified)
  ACTIVE // Normal active status
  SUSPENDED // Temporarily suspended (violation of rules, etc.)
  REVOKED // Permanently banned (serious violation)
  ARCHIVED // Account archived (long-term inactive)
}

model Workspace {
  id              String   @id @default(cuid())
  allowPublicDocs Boolean  @default(false)
  name            String
  description     String?
  avatar          String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  settings Json?

  // relations
  subspaces    Subspace[]
  members      WorkspaceMember[]
  guests       GuestCollaborator[]
  memberGroups MemberGroup[]
  docs         Doc[]
}

enum DocVisibility {
  PUBLIC // visible to everyone, (eg: product user guide, etc.)
  PRIVATE // visible to author
  WORKSPACE // visible to workspace, need further permission control check
}

model Doc {
  id            String  @id @default(cuid())
  type          DocType @default(NOTE)
  title         String
  content       String  @default("{}") // doc json snapshot
  contentBinary Bytes? // yjs collaborative document

  // state mark
  archivedAt  DateTime?
  publishedAt DateTime?
  deletedAt   DateTime?

  // position
  parentId String?
  position Int     @default(0)

  // timestamps
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  // appearance
  icon         String?
  coverImage   CoverImage?
  coverImageId String?

  // visibility
  visibility DocVisibility @default(WORKSPACE)

  // relations
  author   User @relation("DocAuthor", fields: [authorId], references: [id])
  authorId Int

  createdBy   User @relation("DocCreator", fields: [createdById], references: [id])
  createdById Int

  lastModifiedBy   User @relation("DocLastModifier", fields: [lastModifiedById], references: [id])
  lastModifiedById Int

  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId String

  subspace   Subspace? @relation(fields: [subspaceId], references: [id])
  subspaceId String?

  parent   Doc?  @relation("DocToDoc", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children Doc[] @relation("DocToDoc")

  // sharing and permissions
  docShare           DocShare[]
  guestDocPermission GuestDocPermission[]
  publicShare        PublicShare?

  // versions
  revisions          DocRevision[]
  DocGroupPermission DocGroupPermission[]

  // star relationships
  stars             Star[] // Stars for this document
  DocUserPermission DocUserPermission[]
}

model DocRevision {
  id            String   @id @default(cuid())
  title         String
  content       String
  contentBinary Bytes?
  createdAt     DateTime @default(now())

  doc      Doc    @relation(fields: [docId], references: [id], onDelete: Cascade)
  docId    String
  author   User   @relation(fields: [authorId], references: [id])
  authorId Int

  @@index([docId, createdAt])
}

model PublicShare {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Associated document
  doc   Doc    @relation(fields: [docId], references: [id], onDelete: Cascade)
  docId String @unique

  // Sharing configuration
  expiresAt    DateTime? // Expiration time, null means never expires
  allowEdit    Boolean   @default(false) // Allow editing
  allowComment Boolean   @default(false) // Allow commenting
  allowCopy    Boolean   @default(false) // Allow copying
  showTemplate Boolean   @default(false) // Show template button
  showSidebar  Boolean   @default(false) // Show left sidebar

  // Access statistics
  viewCount Int @default(0)

  // Creator
  creator   User @relation(fields: [creatorId], references: [id])
  creatorId Int

  // Security settings
  accessCode String? // Access password, null means no password

  // Edit history
  editHistory PublicEditHistory[]
}

// Public edit history
model PublicEditHistory {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Associated share
  share   PublicShare @relation(fields: [shareId], references: [id], onDelete: Cascade)
  shareId String

  // Editor information
  editorId   String? // Logged-in user ID
  editorName String // Editor name (anonymous users use temporary name)
  editorIp   String // Editor IP address

  // Edit content
  operation Json // Record specific edit operations
}

model WorkspaceMember {
  id        String        @id @default(cuid())
  role      WorkspaceRole @default(MEMBER)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  preferences Json? // User preferences
  index       String? // Fractional index for ordering

  workspace         Workspace           @relation(fields: [workspaceId], references: [id])
  workspaceId       String
  user              User                @relation(fields: [userId], references: [id])
  userId            Int
  DocUserPermission DocUserPermission[]

  @@unique([workspaceId, userId])
  @@index([userId, index])
}

model Subspace {
  id          String       @id @default(cuid())
  name        String
  description String?
  avatar      String?
  type        SubspaceType @default(PUBLIC)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  settings    Json?

  isArchived Boolean @default(false)

  navigationTree Json?
  index          String?

  // relations
  workspace                Workspace                  @relation(fields: [workspaceId], references: [id])
  workspaceId              String
  docs                     Doc[]
  members                  SubspaceMember[]
  SubspaceMemberPermission SubspaceMemberPermission[]

  // star relationships
  stars Star[] // Stars for this subspace
}

model SubspaceMember {
  id        String       @id @default(cuid())
  role      SubspaceRole @default(MEMBER)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  subspace   Subspace @relation(fields: [subspaceId], references: [id])
  subspaceId String

  user              User                @relation(fields: [userId], references: [id])
  userId            Int
  DocUserPermission DocUserPermission[]

  @@unique([subspaceId, userId])
}

enum SubspaceType {
  WORKSPACE_WIDE //  All workspace members are automatically members of this space (cannot leave). 
  PUBLIC // Any workspace member can join and leave freely. 
  INVITE_ONLY // Visible to all members but requires invitation to join.
  PRIVATE //  Only visible to invited members, completely hidden from others.
  PERSONAL // Only visible to the creator, completely hidden from others.
}

model SubspaceMemberPermission {
  id         String     @id @default(cuid())
  permission Permission @default(READ)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // relations
  subspace   Subspace @relation(fields: [subspaceId], references: [id], onDelete: Cascade)
  subspaceId String
  user       User     @relation(fields: [userId], references: [id])
  userId     Int

  // some roles' permission can not be modified
  isEditable Boolean @default(true)

  @@unique([subspaceId, userId])
}

// Group of users in workspace
model MemberGroup {
  id          String    @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  validUntil  DateTime?

  workspace          Workspace            @relation(fields: [workspaceId], references: [id])
  workspaceId        String
  members            MemberGroupUser[]
  DocGroupPermission DocGroupPermission[]
}

model MemberGroupUser {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  group   MemberGroup @relation(fields: [groupId], references: [id])
  groupId String
  user    User        @relation(fields: [userId], references: [id])
  userId  Int

  @@unique([groupId, userId])
}

model DocGroupPermission {
  id         String     @id @default(cuid())
  permission Permission @default(READ) // Permission level: READ, COMMENT, EDIT, SHARE, MANAGE  
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // Core relationships  
  doc     Doc         @relation(fields: [docId], references: [id], onDelete: Cascade)
  docId   String
  group   MemberGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId String

  // User relationships
  user   User @relation("UserGroupPermissions", fields: [userId], references: [id])
  userId Int

  // Permission inheritance support for folder tree sharing  
  createdBy   User                 @relation("CreatedGroupPermissions", fields: [createdById], references: [id])
  createdById Int
  source      DocGroupPermission?  @relation("GroupPermissionSource", fields: [sourceId], references: [id])
  sourceId    String?
  children    DocGroupPermission[] @relation("GroupPermissionSource")

  // Ensure one permission per group per document  
  @@unique([docId, groupId])
  @@index([groupId, createdAt]) // For efficient group permission queries  
}

model DocUserPermission {
  id         String     @id @default(cuid())
  permission Permission @default(READ) // Permission level: READ, COMMENT, EDIT, SHARE, MANAGE  
  index      String?    @db.VarChar(256) // Fractional index for "Shared with me" ordering  
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // Core relationships  
  doc         Doc    @relation(fields: [docId], references: [id], onDelete: Cascade)
  docId       String
  user        User   @relation("UserDocPermissions", fields: [userId], references: [id], onDelete: Cascade)
  userId      Int
  createdBy   User   @relation("CreatedUserPermissions", fields: [createdById], references: [id])
  createdById Int

  // Permission inheritance support for folder tree sharing  
  source   DocUserPermission?  @relation("UserPermissionSource", fields: [sourceId], references: [id])
  sourceId String?
  children DocUserPermission[] @relation("UserPermissionSource")

  // Optional links to workspace/subspace memberships that generated this permission  
  workspaceMember   WorkspaceMember? @relation(fields: [workspaceMemberId], references: [id])
  workspaceMemberId String?
  subspaceMember    SubspaceMember?  @relation(fields: [subspaceMemberId], references: [id])
  subspaceMemberId  String?

  // Ensure one permission per user per document  
  @@unique([docId, userId])
  @@index([userId, index]) // For "Shared with me" ordering  
  @@index([userId, createdAt]) // For chronological queries  
}

// User belongs to other workspace, but come to current workspace as a guest
// can be upgraded to workspace member
model GuestCollaborator {
  id        String      @id @default(cuid())
  email     String
  name      String?
  status    GuestStatus @default(PENDING)
  expireAt  DateTime
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  invitedBy      User                 @relation("InvitedBy", fields: [invitedById], references: [id])
  invitedById    Int
  workspace      Workspace            @relation(fields: [workspaceId], references: [id])
  workspaceId    String
  docPermissions GuestDocPermission[]

  @@unique([email, workspaceId])
}

model GuestDocPermission {
  id         String     @id @default(cuid())
  permission Permission @default(READ)
  expireAt   DateTime
  createdAt  DateTime   @default(now())

  guest   GuestCollaborator @relation(fields: [guestId], references: [id])
  guestId String
  doc     Doc               @relation(fields: [docId], references: [id])
  docId   String

  @@unique([guestId, docId])
}

enum GuestStatus {
  PENDING
  ACTIVE
  EXPIRED
  REVOKED
}

model Password {
  hash String

  user   User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId Int  @unique
}

model Connection {
  id           String @id @default(cuid())
  providerName String // Provider name: github, google etc.
  providerId   String // Provider's user ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId Int // Changed to Int type to match User.id

  @@unique([providerName, providerId])
}

model CoverImage {
  id       String  @id @default(cuid())
  url      String
  scrollY  Float
  doc      Doc     @relation(fields: [docId], references: [id])
  docId    String  @unique
  isPreset Boolean @default(false)
}

model DocShare {
  id       String @id @default(cuid())
  doc      Doc    @relation(fields: [docId], references: [id], onDelete: Cascade)
  docId    String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId Int
  sharedTo User   @relation("SharedToUser", fields: [userId], references: [id], onDelete: Cascade)
  userId   Int

  permission Permission @default(READ)

  // Key field: Support folder tree sharing
  includeChildDocuments Boolean @default(false) // Whether to include child documents

  // Share status control  
  published Boolean   @default(false) // Whether publicly published
  revokedAt DateTime? // Revocation time

  // Access control  
  expiresAt DateTime? // Expiration time
  urlId     String? // Custom URL identifier

  // Statistics  
  viewCount      Int       @default(0) // Number of views
  lastAccessedAt DateTime? // Last access time

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([docId, userId])
  @@index([userId, createdAt])
  @@index([docId, includeChildDocuments])
}

model File {
  id          String   @id @default(cuid())
  key         String   @unique
  url         String   @default("")
  status      String   @default("pending") // pending/active/deleted
  size        Int      @default(0)
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  contentType String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AITokenUsage {
  id            Int      @id @default(autoincrement())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        Int      @unique
  tokensUsed    Int      @default(0)
  lastResetDate DateTime @default(now())
  monthlyLimit  Int      @default(10000)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, lastResetDate])
}

model UserLoginHistory {
  id        String   @id @default(cuid())
  userId    Int
  ip        String?
  location  String?
  loginTime DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Star {
  id        String   @id @default(cuid())
  index     String?  @db.VarChar(256) // For sorting
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations 
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     Int
  doc        Doc?      @relation(fields: [docId], references: [id], onDelete: Cascade)
  docId      String?
  subspace   Subspace? @relation(fields: [subspaceId], references: [id], onDelete: Cascade)
  subspaceId String?

  // Ensure each user can only star a resource once
  @@unique([userId, docId])
  @@unique([userId, subspaceId])
  // Ensure docId and subspaceId cannot both be null
  @@unique([docId, subspaceId])
}

enum WorkspaceRole {
  OWNER // Can delete the workspace/transfer ownership/has all ADMIN permissions
  ADMIN // Can manage workspace settings, add/remove members, add/remove member groups, manage all documents in the workspace, etc
  MEMBER // Can create documents/ join subspaces/ create member groups(if allowed in workspace settings) / Cannot see private content unless explicitly shared
}

enum SubspaceRole {
  ADMIN // Can manage subspace settings, add/remove members, manage  all documents in the subspace, etc
  MEMBER
}

// Doc permission
enum Permission {
  MANAGE
  SHARE
  EDIT
  COMMENT
  READ
  NONE
}

enum DocType {
  NOTE
  WHITEBOARD
  MIND
}
